// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js models for authentication
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// MTR Zones (MTR-01 to MTR-06)
model Zone {
  id                  String                   @id @default(cuid())
  code                String                   @unique // e.g., "MTR-01", "MTR-02"
  name                String // e.g., "HK Station", "Kowloon Station"
  description         String? // Additional details
  active              Boolean                  @default(true)
  equipment           Equipment[]
  schedules           Schedule[]
  equipmentMappings   EquipmentZoneMapping[]
  engineerAssignments ZoneEngineerAssignment[]
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
}

// Equipment/Units (Lifts and Escalators)
model Equipment {
  id              String                @id @default(cuid())
  deviceId        String?               @unique // Device ID from Looker
  equipmentNumber String                @unique // e.g., "HOK-E25", "KOW-E01"
  name            String? // Full name/description
  type            EquipmentType
  location        String? // Station/location name
  buildingId      String? // Building ID from Looker
  buildingName    String? // Building name from Looker
  fullAddress     String? // Full address from Looker
  zone            Zone                  @relation(fields: [zoneId], references: [id])
  zoneId          String
  active          Boolean               @default(true)
  // Admin settings
  canUse2300Slot  Boolean               @default(false) // Units allowed to start at 23:00 (marked in green)
  schedules       Schedule[]
  visits          MaintenanceVisit[]
  zoneMapping     EquipmentZoneMapping? // Admin mapping (zone + week)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@index([canUse2300Slot, active]) // Index for fast queries of 23:00-capable equipment
}

enum EquipmentType {
  ELEVATOR
  ESCALATOR
}

// Engineers (synced from Looker)
model Engineer {
  id                String                   @id @default(cuid())
  name              String
  email             String?                  @unique
  phone             String?
  active            Boolean                  @default(true)
  role              EngineerRole             @default(ENGINEER)
  // CP & RW certificates required for MTR sites
  hasCPCert         Boolean                  @default(false) // CP certificate
  hasRWCert         Boolean                  @default(false) // RW certificate
  // Looker sync metadata
  lookerId          String?                  @unique
  fixedSchedules    Schedule[]               @relation("FixedEngineerSchedules")
  rotatingSchedules Schedule[]               @relation("RotatingEngineerSchedules")
  visits            MaintenanceVisit[]
  zoneAssignments   ZoneEngineerAssignment[]
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @default(now()) @updatedAt
}

enum EngineerRole {
  ADMIN
  OPS
  ENGINEER
  SUPERVISOR
}

// Maintenance Schedule (14-day cycle)
model Schedule {
  id          String    @id @default(cuid())
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  equipmentId String
  zone        Zone      @relation(fields: [zoneId], references: [id])
  zoneId      String

  // R0 Schedule (original locked schedule from MTR)
  r0PlannedDate DateTime // Original committed date (locked in MTR system)

  // R1 Schedule (WM's proposed updated schedule)
  r1PlannedDate DateTime? // Proposed new schedule date (nullable for SKIPPED/MISSED items)

  // Due Date (R0 + 14 days - latest completion date)
  dueDate DateTime // R0PlannedDate + 14 days

  // Cycle tracking (A or B batch)
  batch ScheduleBatch // "A" or "B" batch

  // Time slot (23:00, 1:30, or 3:30)
  timeSlot TimeSlot

  // Engineer assignments (2-man team)
  fixedEngineer      Engineer? @relation("FixedEngineerSchedules", fields: [fixedEngineerId], references: [id])
  fixedEngineerId    String?
  rotatingEngineer   Engineer? @relation("RotatingEngineerSchedules", fields: [rotatingEngineerId], references: [id])
  rotatingEngineerId String?

  // Work Order (OR number from EAMS)
  workOrderNumber     String?   @unique // OR number (e.g., "5000355448")
  mtrPlannedStartDate DateTime? // MTR plan start date (from work order import)

  // Status tracking
  status ScheduleStatus @default(PLANNED)

  // Completion tracking
  completionDate DateTime? // Actual date when work was completed (set when status → COMPLETED)

  // Late completion flag
  isLate Boolean @default(false) // true if completionDate > mtrPlannedStartDate + 6 days (for COMPLETED)
  // or if r1PlannedDate > mtrPlannedStartDate + 6 days (for PLANNED)

  // Last skipped date
  lastSkippedDate DateTime? // Last date when item was skipped/rescheduled

  // Skipped count
  skippedCount Int @default(0) // Number of times item has been rescheduled

  // Execution tracking
  visits      MaintenanceVisit[]
  reschedules Reschedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([equipmentId, r1PlannedDate])
  @@index([zoneId, r1PlannedDate])
  @@index([r1PlannedDate])
  @@index([dueDate])
  @@index([status, updatedAt]) // Optimize queries filtering by status and date
  @@index([status, completionDate]) // Optimize analytics queries by completion date
  @@index([workOrderNumber, status]) // Optimize work order queries
}

enum ScheduleBatch {
  A
  B
}

enum TimeSlot {
  SLOT_2300 // 23:00
  SLOT_0130 // 1:30
  SLOT_0330 // 3:30
}

enum ScheduleStatus {
  PLANNED // Scheduled but not started
  PENDING // Past scheduled date, awaiting validation
  COMPLETED // Completed (use isLate flag for late completion)
  SKIPPED // Skipped, needs rescheduling (dueDate still in future)
  MISSED // Missed deadline (dueDate passed) - FINAL STATUS
  CANCELLED // Cancelled/deleted
  // Deprecated (kept for migration): IN_PROGRESS, COMPLETED_LATE, RESCHEDULED, TO_RESCHEDULE, OVERDUE
}

// Maintenance Visit (actual execution)
model MaintenanceVisit {
  id          String    @id @default(cuid())
  schedule    Schedule  @relation(fields: [scheduleId], references: [id])
  scheduleId  String
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  equipmentId String

  // Execution details
  actualStartDate DateTime // When maintenance actually started
  actualEndDate   DateTime? // When maintenance completed

  // Engineer who performed the work
  engineer   Engineer @relation(fields: [engineerId], references: [id])
  engineerId String

  // Completion status
  completed      Boolean   @default(false)
  completionDate DateTime? // When marked as completed

  // PM Form tracking
  pmFormSubmitted   Boolean   @default(false)
  pmFormSubmittedAt DateTime?

  // EAMS entry tracking
  eamsEntered   Boolean   @default(false)
  eamsEnteredAt DateTime?
  eamsEnteredBy String? // Admin who entered into EAMS

  // Classification (auto-calculated)
  classification VisitClassification

  // Notes/comments
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduleId])
  @@index([equipmentId, actualStartDate])
  @@index([engineerId, actualStartDate])
}

enum VisitClassification {
  COMMITTED_DATE // Completed on committed date (best case)
  ON_TIME // Completed within ±3-5 day window
  LATE // Completed after tolerance window but before due date
  OVERDUE // Completed after due date
  NOT_COMPLETED // Not completed
}

// Rescheduling records
model Reschedule {
  id         String   @id @default(cuid())
  schedule   Schedule @relation(fields: [scheduleId], references: [id])
  scheduleId String

  // Original schedule details
  originalDate DateTime

  // New schedule details
  newDate DateTime
  reason  String?  @db.Text

  // Approval tracking
  mtrApproved   Boolean   @default(false)
  mtrApprovedAt DateTime?
  mtrApprovedBy String?

  // Status
  status RescheduleStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User who created the reschedule request

  @@index([scheduleId])
  @@index([status])
}

enum RescheduleStatus {
  PENDING // Awaiting MTR approval
  APPROVED // Approved by MTR
  REJECTED // Rejected by MTR
  COMPLETED // Rescheduled and completed
}

// Equipment-Zone-Week Mapping (Admin Configuration)
// Only equipment with both zone and week mapping appear in schedules
model EquipmentZoneMapping {
  id          String        @id @default(cuid())
  equipment   Equipment     @relation(fields: [equipmentId], references: [id])
  equipmentId String        @unique
  zone        Zone          @relation(fields: [zoneId], references: [id])
  zoneId      String
  batch       ScheduleBatch // A or B week assignment
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String? // Admin who created the mapping

  @@index([zoneId, batch])
  @@index([equipmentId])
}

// Zone Engineer Assignments (Admin Configuration)
model ZoneEngineerAssignment {
  id         String           @id @default(cuid())
  zone       Zone             @relation(fields: [zoneId], references: [id])
  zoneId     String
  engineer   Engineer         @relation(fields: [engineerId], references: [id])
  engineerId String
  role       ZoneEngineerRole // FIXED_QUALIFIED or FIXED
  active     Boolean          @default(true)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  createdBy  String? // Admin who created the assignment

  @@unique([zoneId, engineerId])
  @@index([zoneId])
  @@index([engineerId])
}

enum ZoneEngineerRole {
  FIXED_QUALIFIED // Fixed engineer with CP & RW certificates (qualified personnel)
  FIXED // Other fixed engineers assigned to zone
}
